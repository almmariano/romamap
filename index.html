<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Er Giro dei Nasoni</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css" />
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f4f4f4; }
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #A30000; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; padding: 20px; box-sizing: border-box; transition: opacity 0.5s; }
        h1 { font-family: 'Lobster', cursive; font-size: 3em; }
        .btn { background: #F1C40F; color: #A30000; padding: 15px 30px; border: none; border-radius: 50px; font-size: 1.5em; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #map { height: 100vh; width: 100%; }
        #counter-box { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 25px; border-radius: 50px; border: 2px solid #F1C40F; z-index: 1000; font-weight: bold; color: #A30000; display: none; }
        .popup-content { text-align: center; font-size: 1.1em; }
        .popup-btn { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 8px; width: 100%; }
        .popup-btn.undo { background: #c0392b; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <h1>A√≤, Amore!</h1>
        <p>Caricamento in corso...</p>
        <p id="debug-msg" style="font-size:0.8em; color:#ffcccc"></p>
        <button id="start-btn" class="btn" onclick="startApp()" style="display:none">Annamo!</button>
    </div>

    <div id="counter-box">üèÜ Fatti: <span id="count">0</span></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>

    <!-- Tenta carregar o arquivo de dados -->
    <script src="dati.js"></script>

    <script>
        let map, markersCluster;
        let savedNasoni = JSON.parse(localStorage.getItem('nasoniCompleted')) || [];

        window.onload = function() {
            const debug = document.getElementById('debug-msg');
            
            // Verifica√ß√£o "Dedo-Duro"
            if (typeof nasoni === 'undefined') {
                debug.innerHTML = "‚ö†Ô∏è ERRORE: Non trovo la lista dei nasoni.<br>Controlla che il file <b>dati.js</b> inizi con <code>var nasoni = ...</code>";
            } else if (!nasoni.features || nasoni.features.length === 0) {
                debug.innerHTML = "‚ö†Ô∏è ERRORE: La lista √® vuota!";
            } else {
                // Sucesso!
                debug.innerHTML = "‚úÖ Ho trovato " + nasoni.features.length + " nasoni!";
                document.getElementById('start-btn').style.display = 'block';
                initMap();
            }
        };

        function startApp() {
            document.getElementById('intro-screen').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('intro-screen').style.display = 'none'; 
                document.getElementById('counter-box').style.display = 'block';
            }, 500);
            updateCounter();
        }

        function initMap() {
            map = L.map('map').setView([41.8902, 12.4922], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);

            // Busca
            const provider = new GeoSearch.OpenStreetMapProvider();
            const searchControl = new GeoSearch.GeoSearchControl({ provider: provider, style: 'bar', searchLabel: 'Cerca...', });
            map.addControl(searchControl);

            markersCluster = L.markerClusterGroup();

            // Adiciona os pontos
            let count = 0;
            nasoni.features.forEach(feature => {
                if (feature.geometry && feature.geometry.coordinates) {
                    const lat = feature.geometry.coordinates[1];
                    const lng = feature.geometry.coordinates[0];
                    const id = feature.id || (lat + "_" + lng);
                    
                    const marker = L.marker([lat, lng]);
                    
                    // L√≥gica do Popup
                    marker.bindPopup(() => {
                        const isDone = savedNasoni.includes(id);
                        const div = document.createElement('div');
                        div.className = 'popup-content';
                        div.innerHTML = `<b>Nasone</b><br><small>${isDone ? "‚úÖ Gi√† fatto!" : "üíß Daje!"}</small><br>`;
                        const btn = document.createElement('button');
                        btn.className = `popup-btn ${isDone ? 'undo' : 'do'}`;
                        btn.innerText = isDone ? "Annulla" : "Bevuto!";
                        btn.onclick = () => toggleNasone(id, marker);
                        div.appendChild(btn);
                        return div;
                    });

                    if(savedNasoni.includes(id)) marker.setOpacity(0.5);
                    markersCluster.addLayer(marker);
                    count++;
                }
            });
            map.addLayer(markersCluster);
            
            // Centraliza o mapa onde tem pontos
            if(count > 0) {
                map.fitBounds(markersCluster.getBounds());
            }
        }

        function toggleNasone(id, marker) {
            const index = savedNasoni.indexOf(id);
            if (index > -1) { savedNasoni.splice(index, 1); marker.setOpacity(1.0); }
            else { savedNasoni.push(id); marker.setOpacity(0.5); }
            localStorage.setItem('nasoniCompleted', JSON.stringify(savedNasoni));
            updateCounter();
            marker.closePopup();
        }

        function updateCounter() {
            document.getElementById('count').innerText = savedNasoni.length;
        }
    </script>
</body>
</html>
