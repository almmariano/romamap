<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Er Giro dei Nasoni</title>
    
    <!-- Mapa (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f4f4f4; overflow: hidden; }
        
        /* TELA DE INTRODU√á√ÉO */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #A30000; color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            text-align: center; padding: 20px; box-sizing: border-box;
            transition: opacity 0.5s;
        }
        h1 { font-family: 'Lobster', cursive; font-size: 3em; margin-bottom: 10px; }
        .btn {
            background: #F1C40F; color: #A30000; padding: 15px 40px;
            border: none; border-radius: 50px; font-size: 1.5em; font-weight: bold;
            cursor: pointer; margin-top: 20px; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* MAPA */
        #map { height: 100vh; width: 100%; }

        /* BARRA DE PESQUISA (Estilo Google Maps) */
        #search-bar {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: white; border-radius: 8px;
            display: flex; align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 5000; /* Bem alto para aparecer */
            padding: 8px;
            display: none; /* Escondido at√© iniciar */
        }
        #search-input {
            border: none; outline: none; font-size: 16px;
            flex: 1; padding: 5px;
        }
        #search-btn {
            background: #A30000; color: white; border: none;
            border-radius: 4px; padding: 8px 12px;
            cursor: pointer; font-weight: bold;
        }

        /* CONTADOR */
        #counter-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 25px; border-radius: 50px;
            border: 3px solid #F1C40F; z-index: 4000; font-weight: bold; color: #A30000;
            display: none; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* POPUPS */
        .popup-content { text-align: center; font-size: 1.1em; min-width: 150px; }
        .popup-btn { background: #27ae60; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; }
        .popup-btn.undo { background: #c0392b; }
    </style>
</head>
<body>

    <!-- INTRO -->
    <div id="intro-screen">
        <h1>A√≤, Amore!</h1>
        <p>Trovamo 'sti nasoni!</p>
        <p id="status-msg" style="margin-top:20px; color: #FFD700; font-size: 0.9em;">Caricamento...</p>
        <button id="start-btn" class="btn" onclick="startApp()" style="display:none">Annamo!</button>
    </div>

    <!-- BARRA DE PESQUISA -->
    <div id="search-bar">
        <input type="text" id="search-input" placeholder="Cerca via (es: Colosseo)..." onkeypress="checkEnter(event)">
        <button id="search-btn" onclick="searchAddress()">üîç</button>
    </div>

    <!-- MAPA E CONTADOR -->
    <div id="counter-box">üèÜ Fatti: <span id="count">0</span></div>
    <div id="map"></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- DADOS (Se der erro, avisa) -->
    <script src="dati.js" onerror="alert('Errore: File dati.js non trovato!')"></script>

    <script>
        let map;
        let savedNasoni = JSON.parse(localStorage.getItem('nasoniCompleted')) || [];

        // --- INICIALIZA√á√ÉO SEGURA ---
        window.onload = function() {
            // Tenta verificar se os dados existem
            if (typeof nasoni !== 'undefined') {
                document.getElementById('status-msg').innerText = "‚úÖ " + nasoni.features.length + " nasoni pronti!";
                document.getElementById('start-btn').style.display = 'block';
                // J√° desenha o mapa nos bastidores
                initMap();
            } else {
                // Se falhar, avisa mas libera o bot√£o depois de 2 segundos (Plano B)
                document.getElementById('status-msg').innerText = "‚ö†Ô∏è Dati lenti... aspetta...";
                setTimeout(() => {
                    document.getElementById('start-btn').style.display = 'block';
                    initMap(); // Tenta iniciar mesmo assim
                }, 2000);
            }
        };

        function startApp() {
            document.getElementById('intro-screen').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('intro-screen').style.display = 'none'; 
                document.getElementById('counter-box').style.display = 'block';
                document.getElementById('search-bar').style.display = 'flex'; // Mostra a busca
                map.invalidateSize(); // Destrava o mapa se ele estiver cinza
            }, 500);
            updateCounter();
        }

        function initMap() {
            if(map) return; // N√£o cria duas vezes

            map = L.map('map', { zoomControl: false }).setView([41.8902, 12.4922], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Adiciona os pontos
            if(typeof nasoni !== 'undefined' && nasoni.features) {
                nasoni.features.forEach(feature => {
                    if (feature.geometry && feature.geometry.coordinates) {
                        const lng = feature.geometry.coordinates[0];
                        const lat = feature.geometry.coordinates[1];
                        const id = feature.id || (lat + "_" + lng);
                        const isDone = savedNasoni.includes(id);

                        // Bolinha Vermelha (ou Verde)
                        const circle = L.circleMarker([lat, lng], {
                            radius: 6,
                            fillColor: isDone ? "#2ecc71" : "#e74c3c", 
                            color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                        }).addTo(map);

                        // Popup
                        const popupContent = document.createElement('div');
                        popupContent.className = 'popup-content';
                        popupContent.innerHTML = `<b>Nasone</b><br><small>${isDone ? "‚úÖ Fatta!" : "üíß Daje!"}</small><br>`;
                        const btn = document.createElement('button');
                        btn.className = `popup-btn ${isDone ? 'undo' : 'do'}`;
                        btn.innerText = isDone ? "Annulla" : "Bevuto!";
                        btn.onclick = () => toggleNasone(id, circle);
                        popupContent.appendChild(btn);
                        
                        circle.bindPopup(popupContent);
                    }
                });
            }
        }

        // --- SISTEMA DE BUSCA MANUAL (Simples e Funcional) ---
        function searchAddress() {
            const input = document.getElementById('search-input');
            const query = input.value;
            
            if (!query) return;

            const btn = document.getElementById('search-btn');
            btn.innerText = "‚è≥"; // Ampulheta enquanto busca

            // Usa a API p√∫blica do Nominatim (OpenStreetMap)
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query} Roma, Italia&limit=1`)
                .then(response => response.json())
                .then(data => {
                    btn.innerText = "üîç";
                    if (data.length > 0) {
                        const lat = data[0].lat;
                        const lon = data[0].lon;
                        map.setView([lat, lon], 17); // Voa para o lugar
                        // Adiciona um marcador tempor√°rio para mostrar onde buscou
                        L.marker([lat, lon]).addTo(map).bindPopup(`üìç ${query}`).openPopup();
                    } else {
                        alert("A√≤! Nun l'ho trovato. Prova n'artra via.");
                    }
                })
                .catch(err => {
                    btn.innerText = "üîç";
                    alert("Errore di connessione.");
                });
        }

        function checkEnter(event) {
            if (event.key === "Enter") searchAddress();
        }

        // --- L√ìGICA DOS BEBEDOUROS ---
        function toggleNasone(id, marker) {
            const index = savedNasoni.indexOf(id);
            if (index > -1) {
                savedNasoni.splice(index, 1);
                marker.setStyle({ fillColor: "#e74c3c" }); // Vermelho
                marker.closePopup();
            } else {
                savedNasoni.push(id);
                marker.setStyle({ fillColor: "#2ecc71" }); // Verde
                marker.closePopup();
            }
            localStorage.setItem('nasoniCompleted', JSON.stringify(savedNasoni));
            updateCounter();
            setTimeout(() => marker.openPopup(), 100);
        }

        function updateCounter() {
            document.getElementById('count').innerText = savedNasoni.length;
        }
    </script>
</body>
</html>
