<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Er Giro dei Nasoni</title>
    
    <!-- Mapa (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f4f4f4; overflow: hidden; }
        
        /* TELA DE INTRODU√á√ÉO */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #A30000; color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            text-align: center; padding: 20px; box-sizing: border-box;
            transition: opacity 0.5s;
        }
        h1 { font-family: 'Lobster', cursive; font-size: 3em; margin-bottom: 10px; }
        .btn {
            background: #F1C40F; color: #A30000; padding: 15px 40px;
            border: none; border-radius: 50px; font-size: 1.5em; font-weight: bold;
            cursor: pointer; margin-top: 20px; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* MAPA */
        #map { height: 100vh; width: 100%; }

        /* BARRA DE PESQUISA PERSONALIZADA */
        #search-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: white; border-radius: 30px;
            display: flex; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 2000; /* Fica acima do mapa */
            padding: 5px 15px;
            display: none; /* Escondido at√© come√ßar */
        }
        #search-input {
            border: none; outline: none; font-size: 16px;
            flex: 1; padding: 10px; border-radius: 30px;
        }
        #search-btn {
            background: #A30000; color: white; border: none;
            border-radius: 50%; width: 40px; height: 40px;
            cursor: pointer; font-weight: bold; display: flex;
            align-items: center; justify-content: center;
        }

        /* CONTADOR */
        #counter-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 25px; border-radius: 50px;
            border: 3px solid #F1C40F; z-index: 1000; font-weight: bold; color: #A30000;
            display: none; white-space: nowrap;
        }

        /* POPUPS */
        .popup-content { text-align: center; font-size: 1.1em; min-width: 150px; }
        .popup-btn { background: #27ae60; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; }
        .popup-btn.undo { background: #c0392b; }
    </style>
</head>
<body>

    <!-- INTRO -->
    <div id="intro-screen">
        <h1>A√≤, Amore!</h1>
        <p>Trovamo 'sti nasoni!</p>
        <p id="status-msg" style="margin-top:20px; color: #FFD700; font-size: 0.9em;">Caricamento...</p>
        <button id="start-btn" class="btn" onclick="startApp()" style="display:none">Annamo!</button>
    </div>

    <!-- BARRA DE PESQUISA -->
    <div id="search-container">
        <input type="text" id="search-input" placeholder="And√≤ stai? (Cerca via...)" onkeypress="handleEnter(event)">
        <button id="search-btn" onclick="searchLocation()">üîç</button>
    </div>

    <!-- MAPA E CONTADOR -->
    <div id="counter-box">üèÜ Fatti: <span id="count">0</span></div>
    <div id="map"></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- DADOS -->
    <script src="dati.js" onerror="fileError()"></script>

    <script>
        let map;
        let savedNasoni = JSON.parse(localStorage.getItem('nasoniCompleted')) || [];

        function fileError() {
            document.getElementById('status-msg').innerHTML = "‚ùå ERRORE: dati.js mancante.";
        }

        window.onload = function() {
            if (typeof nasoni === 'undefined') {
                fileError();
            } else {
                document.getElementById('status-msg').innerText = "‚úÖ " + nasoni.features.length + " nasoni pronti!";
                document.getElementById('start-btn').style.display = 'block';
                initMap();
            }
        };

        function startApp() {
            document.getElementById('intro-screen').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('intro-screen').style.display = 'none'; 
                document.getElementById('counter-box').style.display = 'block';
                document.getElementById('search-container').style.display = 'flex'; // Mostra a busca
                map.invalidateSize();
            }, 500);
            updateCounter();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([41.8902, 12.4922], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            let bounds = [];

            if(nasoni && nasoni.features) {
                nasoni.features.forEach(feature => {
                    if (feature.geometry && feature.geometry.coordinates) {
                        const lng = feature.geometry.coordinates[0];
                        const lat = feature.geometry.coordinates[1];
                        const id = feature.id || (lat + "_" + lng);
                        const isDone = savedNasoni.includes(id);

                        const circle = L.circleMarker([lat, lng], {
                            radius: 6,
                            fillColor: isDone ? "#2ecc71" : "#e74c3c", 
                            color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                        }).addTo(map);

                        bounds.push([lat, lng]);

                        const popupContent = document.createElement('div');
                        popupContent.className = 'popup-content';
                        popupContent.innerHTML = `<b>Nasone</b><br><small>${isDone ? "‚úÖ Fatta!" : "üíß Daje!"}</small><br>`;
                        const btn = document.createElement('button');
                        btn.className = `popup-btn ${isDone ? 'undo' : 'do'}`;
                        btn.innerText = isDone ? "Annulla" : "Bevuto!";
                        btn.onclick = () => toggleNasone(id, circle);
                        popupContent.appendChild(btn);
                        
                        circle.bindPopup(popupContent);
                    }
                });
            }
        }

        // --- FUN√á√ÉO DE PESQUISA MANUAL ---
        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            if(!query) return;

            // √çcone de carregando no bot√£o
            const btn = document.getElementById('search-btn');
            btn.innerHTML = "‚è≥";

            try {
                // Usa o servi√ßo oficial do OpenStreetMap (Nominatim)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query} Roma&limit=1`);
                const data = await response.json();

                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    // Voa para o local
                    map.flyTo([lat, lon], 16);
                } else {
                    alert("A√≤! Nun l'ho trovato. Prova n'artra via.");
                }
            } catch (error) {
                alert("Errore di connessione.");
            } finally {
                btn.innerHTML = "üîç";
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') searchLocation();
        }
        // ---------------------------------

        function toggleNasone(id, marker) {
            const index = savedNasoni.indexOf(id);
            if (index > -1) {
                savedNasoni.splice(index, 1);
                marker.setStyle({ fillColor: "#e74c3c" });
                marker.closePopup();
            } else {
                savedNasoni.push(id);
                marker.setStyle({ fillColor: "#2ecc71" });
                marker.closePopup();
            }
            localStorage.setItem('nasoniCompleted', JSON.stringify(
